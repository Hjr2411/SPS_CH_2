<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chamados • SPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
</head>
<body>
<header class="topbar">
  <div class="brand">SPS • Chamados</div>
  <nav class="nav">
    <a href="./dashboard.html">Dashboard</a>
    <a href="./chamados.html" class="active">Chamados</a>
    <a href="./usuarios.html">Usuários</a>
    <button id="logoutBtn" class="btn danger outline">Sair</button>
  </nav>
</header>

<main class="container">
  <!-- Formulário de criação/edição -->
  <section class="panel">
    <h2>Novo Chamado</h2>
    <form id="formChamado" class="grid form">
      <input type="hidden" id="chamadoId" />
      <label for="titulo">Título
        <input id="titulo" required />
      </label>
      <label for="prioridade">Prioridade
        <select id="prioridade" required>
          <option value="Alta">Alta</option>
          <option value="Média" selected>Média</option>
          <option value="Baixa">Baixa</option>
        </select>
      </label>
      <label for="status">Status
        <select id="status" required>
          <option value="Aberto">Aberto</option>
          <option value="Fechado">Fechado</option>
        </select>
      </label>
      <label for="descricao" class="full">Descrição
        <textarea id="descricao" rows="3" placeholder="Descreva o problema..." required></textarea>
      </label>
      <button class="btn primary">Salvar</button>
      <button type="button" id="btnCancelar" class="btn">Cancelar</button>
    </form>
  </section>

  <!-- Tabela de chamados -->
  <section class="panel">
    <h2>Lista de Chamados</h2>
    <div class="toolbar">
      <input id="filtroBusca" placeholder="Buscar por título..." />
      <select id="filtroStatus">
        <option value="">Status (todos)</option>
        <option value="Aberto">Aberto</option>
        <option value="Fechado">Fechado</option>
      </select>
      <select id="filtroPrioridade">
        <option value="">Prioridade (todas)</option>
        <option value="Alta">Alta</option>
        <option value="Média">Média</option>
        <option value="Baixa">Baixa</option>
      </select>
    </div>
    <table class="table" id="tblChamados">
      <thead>
        <tr>
          <th>Título</th>
          <th>Prioridade</th>
          <th>Status</th>
          <th>Criado por</th>
          <th>Criado em</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script type="module">
  import { requireAuth, logout } from "./services/auth.js";
  import { createChamado, listChamados, updateChamado, deleteChamado } from "./services/chamados.js";
  import { formatDate, toast } from "./assets/utils.js";

  const user = requireAuth();
  document.getElementById("logoutBtn").addEventListener("click", () => {
    logout();
    window.location.href = "./index.html";
  });

  const form = document.getElementById("formChamado");
  const tbody = document.querySelector("#tblChamados tbody");

  async function preencherTabela() {
    const busca = document.getElementById("filtroBusca").value.trim().toLowerCase();
    const status = document.getElementById("filtroStatus").value;
    const prioridade = document.getElementById("filtroPrioridade").value;

    const data = await listChamados({ busca, status, prioridade });
    tbody.innerHTML = "";
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Sem registros</td></tr>`;
      return;
    }
    for (const c of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.titulo}</td>
        <td><span class="pill ${c.prioridade}">${c.prioridade}</span></td>
        <td>${c.status}</td>
        <td>${c.criadoPor?.username || "-"}</td>
        <td>${formatDate(c.criadoEm)}</td>
        <td>
          <button class="btn xs" data-edit="${c.id}">Editar</button>
          <button class="btn xs danger" data-del="${c.id}">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      titulo: document.getElementById("titulo").value.trim(),
      descricao: document.getElementById("descricao").value.trim(),
      prioridade: document.getElementById("prioridade").value,
      status: document.getElementById("status").value
    };
    const id = document.getElementById("chamadoId").value;
    try {
      if (id) {
        await updateChamado(id, payload);
        toast("Chamado atualizado ✔️", "success");
      } else {
        await createChamado(payload);
        toast("Chamado criado ✔️", "success");
      }
      form.reset();
      document.getElementById("chamadoId").value = "";
      await preencherTabela();
    } catch (err) {
      toast(err.message, "error");
    }
  });

  document.getElementById("btnCancelar").addEventListener("click", () => {
    form.reset();
    document.getElementById("chamadoId").value = "";
  });

  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.dataset.edit || btn.dataset.del;
    if (btn.dataset.edit) {
      const row = btn.closest("tr").children;
      document.getElementById("titulo").value = row[0].textContent.trim();
      document.getElementById("prioridade").value = row[1].textContent.trim();
      document.getElementById("status").value = row[2].textContent.trim();
      document.getElementById("descricao").value = ""; // descrição completa só no DB
      document.getElementById("chamadoId").value = id;
      window.scrollTo({ top: 0, behavior: "smooth" });
    } else if (btn.dataset.del) {
      if (confirm("Deseja excluir este chamado?")) {
        await deleteChamado(id);
        toast("Chamado excluído", "info");
        await preencherTabela();
      }
    }
  });

  ["filtroBusca","filtroStatus","filtroPrioridade"].forEach(id => {
    document.getElementById(id).addEventListener("input", preencherTabela);
    document.getElementById(id).addEventListener("change", preencherTabela);
  });

  preencherTabela();
</script>
</body>
</html>

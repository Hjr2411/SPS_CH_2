<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chamados ‚Ä¢ SPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    /* Ajustes espec√≠ficos da p√°gina */
    .req::after { content:" *"; color:#ef4444; font-weight:700; }
    .hint { font-size:.85rem; color: var(--muted); }
    .icon-btn { background: transparent; border: none; cursor: pointer; color: var(--text); }
    .tooltip { position: relative; }
    .tooltip[data-tip]:hover::after {
      content: attr(data-tip);
      position: absolute; left: 50%; transform: translateX(-50%); bottom: 120%;
      white-space: pre-wrap; max-width: 360px; padding: .6rem .8rem;
      background: #0b1020; border:1px solid var(--border); border-radius: 10px;
      color: var(--text); box-shadow: 0 8px 20px rgba(0,0,0,.35); z-index: 50;
    }
    /* Grid 3√ó3: 3 colunas no desktop, quebra para 2 e 1 no mobile */
    .grid.form { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 900px){ .grid.form { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 600px){ .grid.form { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">SPS ‚Ä¢ Chamados</div>
  <nav class="nav">
    <a href="./dashboard.html">Dashboard</a>
    <a href="./chamados.html" class="active">Chamados</a>
    <a href="./usuarios.html">Usu√°rios</a>
    <button id="logoutBtn" class="btn danger outline">Sair</button>
  </nav>
</header>

<main class="container">
  <!-- FORM 3√ó3 -->
  <section class="panel">
    <h2>Novo Chamado</h2>
    <form id="formChamado" class="grid form" autocomplete="off">
      <input type="hidden" id="chamadoId" />

      <!-- Linha 1: Analista | Data/Hora | Chamado -->
      <label>Analista
        <input id="analista" type="text" readonly />
      </label>
      <label>Data/Hora
        <input id="data" type="datetime-local" />
        <span class="hint">Se vazio, usa agora.</span>
      </label>
      <label class="req">Chamado
        <input id="chamado" type="text" placeholder="T√≠tulo do chamado" required />
      </label>

      <!-- Linha 2: MSISDN | Equipamento | Cen√°rio -->
      <label class="req">MSISDN
        <input id="msisdn" type="text" inputmode="numeric" maxlength="11" placeholder="Ex.: 11987654321" required />
        <span class="hint">11 d√≠gitos (DDD+n√∫mero).</span>
      </label>
      <label>Equipamento
        <select id="equipamentoSelect"></select>
        <input id="equipamentoOutro" placeholder="Outro equipamento" style="display:none" />
      </label>
      <label>Cen√°rio
        <select id="cenarioSelect"></select>
        <input id="cenarioOutro" placeholder="Outro cen√°rio" style="display:none" />
      </label>

      <!-- Linha 3: Observa√ß√µes (span 3) -->
      <label class="full" style="grid-column: 1/-1">Observa√ß√µes
        <textarea id="observacoes" rows="3" maxlength="300" placeholder="(opcional, at√© 300 caracteres)"></textarea>
      </label>

      <button class="btn primary">Salvar</button>
      <button type="button" id="btnCancelar" class="btn">Cancelar</button>
    </form>
  </section>

  <!-- Lista + filtros + Export CSV -->
  <section class="panel">
    <h2>Lista de Chamados</h2>

    <div class="toolbar" style="display:flex; gap:.5rem; align-items:end; flex-wrap:wrap;">
      <label style="flex:1; min-width: 220px;">Busca (texto)
        <input id="filtroBusca" placeholder="msisdn, chamado, analista, equipamento..." />
      </label>
      <label>De
        <input id="filtroDataIni" type="datetime-local" />
      </label>
      <label>At√©
        <input id="filtroDataFim" type="datetime-local" />
      </label>
      <button id="btnFiltrar" class="btn">Aplicar</button>
      <button id="btnLimpar" class="btn">Limpar</button>
      <button id="btnExportar" class="btn outline">Exportar CSV</button>
    </div>

    <table class="table" id="tblChamados">
      <thead>
        <tr>
          <th>Data</th>
          <th>Analista</th>
          <th>Chamado</th>
          <th>Linha/MSISDN</th>
          <th>Equipamento</th>
          <th>Cen√°rio</th>
          <th>Obs.</th>
          <th style="width:160px">A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script type="module">
  import { requireAuth, logout } from "./services/auth.js";
  import { createChamado, listChamados, updateChamado, deleteChamado } from "./services/chamados.js";
  import { formatDate, toast } from "./assets/utils.js";
  import { rtdb } from "./config/firebase_config.js";
  import { ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  // Sess√£o/role
  const session = requireAuth();
  const isAdmin = session?.role === "admin";
  const currentUser = session?.username || "-";
  document.getElementById("logoutBtn").addEventListener("click", () => { logout(); window.location.href="./index.html"; });

  // Refs
  const form = document.getElementById("formChamado");
  const inId = document.getElementById("chamadoId");
  const inAnalista = document.getElementById("analista");
  const inData = document.getElementById("data");
  const inChamado = document.getElementById("chamado");
  const inMSISDN = document.getElementById("msisdn");
  const selEquip = document.getElementById("equipamentoSelect");
  const inEqOutro = document.getElementById("equipamentoOutro");
  const selCen = document.getElementById("cenarioSelect");
  const inCenOutro = document.getElementById("cenarioOutro");
  const inObs = document.getElementById("observacoes");

  const tbody = document.querySelector("#tblChamados tbody");
  const filtroBusca = document.getElementById("filtroBusca");
  const filtroDataIni = document.getElementById("filtroDataIni");
  const filtroDataFim = document.getElementById("filtroDataFim");
  document.getElementById("btnFiltrar").addEventListener("click", preencherTabela);
  document.getElementById("btnLimpar").addEventListener("click", () => {
    filtroBusca.value = ""; filtroDataIni.value = ""; filtroDataFim.value = "";
    preencherTabela();
  });
  document.getElementById("btnExportar").addEventListener("click", exportarCSV);

  // Estado inicial
  inAnalista.value = currentUser;

  // Utils
  const onlyDigits = (s) => (s || "").replace(/\D+/g,"");
  const validarMSISDN = (v) => onlyDigits(v).length === 11; // valida√ß√£o apenas no formul√°rio
  const parseDTLocal = (v) => { if (!v) return null; const d = new Date(v); return isNaN(d) ? null : d.getTime(); };

  function toggleOutro(selectEl, inputEl) {
    if (selectEl.value === "__outro__") { inputEl.style.display = ""; inputEl.focus(); }
    else { inputEl.style.display = "none"; inputEl.value = ""; }
  }
  selEquip.addEventListener("change", () => toggleOutro(selEquip, inEqOutro));
  selCen.addEventListener("change", () => toggleOutro(selCen, inCenOutro));

  // Listas: app/listas/equipamentos e app/listas/cenarios
  async function carregarListas() {
    const eqSnap = await get(child(ref(rtdb), "app/listas/equipamentos"));
    const eqArr = eqSnap.exists() ? eqSnap.val().map(String).filter(Boolean) : [];

    const cenSnap = await get(child(ref(rtdb), "app/listas/cenarios"));
    const cenArr = cenSnap.exists() ? cenSnap.val().map(String).filter(Boolean) : [];

    const mk = (arr) => arr.map(v => `<option value="${v}">${v}</option>`).join("");
    selEquip.innerHTML = `<option value="">(selecione)</option>${mk(eqArr)}<option value="__outro__">Outro‚Ä¶</option>`;
    selCen.innerHTML = `<option value="">(selecione)</option>${mk(cenArr)}<option value="__outro__">Outro‚Ä¶</option>`;
  }

  // Tabela (sem Status). Exibi√ß√£o: n√£o valida MSISDN.
  async function preencherTabela() {
    const busca = (filtroBusca.value || "").trim().toLowerCase();
    const dtIni = parseDTLocal(filtroDataIni.value);
    const dtFim = parseDTLocal(filtroDataFim.value);

    const data = await listChamados({ busca }); // servi√ßo j√° busca por v√°rios campos
    const filtered = data.filter(c => {
      const created = Number(c.criadoEm || 0);
      if (dtIni && created < dtIni) return false;
      if (dtFim && created > dtFim) return false;

      // bucket extra pra garantir busca por msisdn, chamado, analista, equipamento
      const bucket = [c.titulo, c.linha, c.criadoPor?.username, c.equipamento]
        .map(v => String(v || "").toLowerCase()).join("|");
      if (busca && !bucket.includes(busca)) return false;

      return true;
    });

    tbody.innerHTML = "";
    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Sem registros</td></tr>`;
      return;
    }

    for (const c of filtered) {
      const obs = c.descricao || "";
      const canEdit = isAdmin || (c.criadoPor?.username === currentUser);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDate(c.criadoEm)}</td>
        <td>${c.criadoPor?.username || "-"}</td>
        <td>${c.titulo || "-"}</td>
        <td>${c.linha || "-"}</td>
        <td>${c.equipamento || "-"}</td>
        <td>${c.cenario || "-"}</td>
        <td>
          ${obs ? `<button class="icon-btn tooltip" data-tip="${obs.replace(/"/g,'&quot;')}" data-copy="${obs}" title="Copiar observa√ß√£o" aria-label="Observa√ß√£o">üìã</button>` : `<span class="muted">‚Äî</span>`}
        </td>
        <td>
          <button class="btn xs" data-edit="${c.id}" ${canEdit ? "" : "disabled"}>Editar</button>
          ${isAdmin ? `<button class="btn xs danger" data-del="${c.id}">Excluir</button>` : ""}
        </td>`;
      tbody.appendChild(tr);
    }
  }

  // Copiar observa√ß√£o
  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button.icon-btn");
    if (!btn) return;
    try {
      await navigator.clipboard.writeText(btn.getAttribute("data-copy") || "");
      toast("Observa√ß√£o copiada!", "success");
    } catch { toast("Falha ao copiar.", "error"); }
  });

  // Salvar (criar/editar) ‚Äî salva descricao; grava linha/equipamento/cenario nos n√≥s pr√≥prios
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const msisdn = onlyDigits(inMSISDN.value);
    if (!validarMSISDN(msisdn)) { toast("MSISDN deve ter 11 d√≠gitos.", "error"); inMSISDN.focus(); return; }
    if (!inChamado.value.trim()) { toast("Campo 'Chamado' √© obrigat√≥rio.", "error"); inChamado.focus(); return; }

    const equipamento = selEquip.value === "__outro__" ? (inEqOutro.value || "").trim() : selEquip.value;
    const cenario = selCen.value === "__outro__" ? (inCenOutro.value || "").trim() : selCen.value;
    const descricao = (inObs.value || "").trim();
    const chosen = parseDTLocal(inData.value); // opcional

    const base = { titulo: inChamado.value.trim(), descricao, prioridade: "M√©dia", status: "Aberto" };
    const id = inId.value;

    try {
      if (id) {
        await updateChamado(id, {
          titulo: base.titulo,
          descricao: base.descricao,
          equipamento, linha: msisdn, cenario,
          ...(chosen ? { createdAt: chosen } : {})
        });
        toast("Chamado atualizado ‚úîÔ∏è", "success");
      } else {
        const novo = await createChamado(base);
        await updateChamado(novo.id, {
          equipamento, linha: msisdn, cenario,
          ...(chosen ? { createdAt: chosen } : {})
        });
        toast("Chamado criado ‚úîÔ∏è", "success");
      }

      form.reset(); inId.value = ""; inAnalista.value = currentUser;
      inEqOutro.style.display="none"; inCenOutro.style.display="none";
      await preencherTabela();
      await carregarListas();
    } catch (err) {
      toast(err.message || "Erro ao salvar", "error");
    }
  });

  // Cancelar
  document.getElementById("btnCancelar").addEventListener("click", () => {
    form.reset(); inId.value = ""; inAnalista.value = currentUser;
    inEqOutro.style.display="none"; inCenOutro.style.display="none";
  });

  // Editar/Excluir (perfis)
  tbody.addEventListener("click", async (e) => {
    const b = e.target.closest("button"); if (!b) return;
    const id = b.dataset.edit || b.dataset.del;

    if (b.dataset.edit) {
      // Carrega a linha renderizada (para precis√£o total, poderia buscar por id no RTDB)
      const row = b.closest("tr").children;
      inId.value = id;
      inChamado.value = row[2].textContent.trim();
      inMSISDN.value = row[3].textContent.trim();

      const eq = row[4].textContent.trim();
      if ([...selEquip.options].some(o=>o.value===eq)) { selEquip.value = eq; inEqOutro.style.display="none"; inEqOutro.value=""; }
      else { selEquip.value="__outro__"; inEqOutro.style.display=""; inEqOutro.value = eq; }

      const cen = row[5].textContent.trim();
      if ([...selCen.options].some(o=>o.value===cen)) { selCen.value = cen; inCenOutro.style.display="none"; inCenOutro.value=""; }
      else { selCen.value="__outro__"; inCenOutro.style.display=""; inCenOutro.value = cen; }

      const obsBtn = row[6].querySelector("button.icon-btn");
      inObs.value = obsBtn ? (obsBtn.getAttribute("data-copy") || "") : "";

      inData.value = ""; // edi√ß√£o opcional de data
      window.scrollTo({ top: 0, behavior: "smooth" });
    } else if (b.dataset.del) {
      if (!isAdmin) return;
      if (confirm("Excluir este chamado?")) {
        await deleteChamado(id);
        toast("Chamado exclu√≠do", "info");
        await preencherTabela();
        await carregarListas();
      }
    }
  });

  // Exportar CSV (respeita filtros atuais)
  async function exportarCSV() {
    const busca = (filtroBusca.value || "").trim().toLowerCase();
    const dtIni = parseDTLocal(filtroDataIni.value);
    const dtFim = parseDTLocal(filtroDataFim.value);
    const data = await listChamados({ busca });

    const filtered = data.filter(c => {
      const created = Number(c.criadoEm || 0);
      if (dtIni && created < dtIni) return false;
      if (dtFim && created > dtFim) return false;
      const bucket = [c.titulo, c.linha, c.criadoPor?.username, c.equipamento]
        .map(v => String(v||"").toLowerCase()).join("|");
      if (busca && !bucket.includes(busca)) return false;
      return true;
    });

    const rows = [];
    rows.push(["Data","Analista","Chamado","MSISDN","Equipamento","Cen√°rio","Observa√ß√µes"]);
    for (const c of filtered) {
      rows.push([
        formatDate(c.criadoEm),
        c.criadoPor?.username || "",
        c.titulo || "",
        c.linha || "",
        c.equipamento || "",
        c.cenario || "",
        c.descricao || ""
      ]);
    }

    const csv = "\uFEFF" + rows.map(r => r.map(cell => `"${String(cell??"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `chamados_${new Date().toISOString().replace(/[:.]/g,"-")}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // Boot
  await carregarListas();
  await preencherTabela();
</script>
</body>
</html>
